name: main

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      # 1) Start Minikube on the GitHub Actions runner
      - name: Start Minikube
        uses: medyagh/setup-minikube@latest
        # You can optionally set resources or driver:
        # with:
        #   driver: docker
        #   cpus: 2
        #   memory: 2048

      # 2) Build the Docker image inside Minikube
      # This makes the image available to the Minikube cluster
      - name: Build Docker image
        run: |
          minikube image build -t rick-and-morty-app:latest .

      # 3) Deploy the application using kubectl
      - name: Deploy using kubectl
        run: |
          kubectl apply -f yamls/Deployment.yaml
          kubectl apply -f yamls/Service.yaml
          kubectl apply -f yamls/Ingress.yaml

      # 4) Wait for pods, then test the endpoints
      - name: Test endpoints
        run: |
          # Wait a few seconds for the Pods to become ready
          sleep 10

          # Check pod status
          kubectl get pods

          # Port-forward to local port 5000
          kubectl port-forward svc/rick-and-morty-service 5000:80 &
          sleep 5

          # Test the healthcheck endpoint
          curl http://localhost:5000/healthcheck

          # Test the characters endpoint
          curl http://localhost:5000/characters
